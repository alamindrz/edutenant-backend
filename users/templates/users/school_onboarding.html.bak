<!-- templates/users/school_onboarding.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Create Your School - Edusuite{% endblock %}

{% block page_title %}Create Your School{% endblock %}
{% block page_subtitle %}Transform your school into a digital institution in minutes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Steps -->
            <div class="text-center mb-5">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                         style="width: 40px; height: 40px;">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="bg-primary" style="height: 3px; width: 100px;"></div>
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                         style="width: 40px; height: 40px;">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="bg-primary" style="height: 3px; width: 100px;"></div>
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                         style="width: 40px; height: 40px;">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
                <p class="text-muted">Create Account → Setup School → Get Started</p>
            </div>

            <div class="card border-0 shadow-lg">
                <div class="card-body p-4 p-md-5">
                    <form method="post" id="schoolOnboardingForm" novalidate>
                        {% csrf_token %}
                        
                        {% if messages %}
                        <div class="mb-4">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Left Column: Account Creation (only if not logged in) -->
                            {% if not request.user.is_authenticated %}
                            <div class="col-lg-6 border-end-lg pe-lg-4 mb-4 mb-lg-0">
                                <h4 class="mb-4"><i class="bi bi-person me-2"></i>Create Admin Account</h4>
                                <p class="text-muted mb-4">This will be your login as the school principal.</p>
                                
                                <!-- Name Fields -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="admin_first_name" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="admin_first_name" name="admin_first_name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="admin_last_name" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="admin_last_name" name="admin_last_name" required>
                                    </div>
                                </div>
                                
                                <!-- Email -->
                                <div class="mb-3">
                                    <label for="admin_email" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="admin_email" name="admin_email" required>
                                    <div class="form-text">This will be your login username</div>
                                </div>
                                
                                <!-- Phone -->
                                <div class="mb-3">
                                    <label for="admin_phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="admin_phone" name="admin_phone">
                                </div>
                                
                                <!-- Password -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="admin_password" class="form-label">Password *</label>
                                        <input type="password" class="form-control" id="admin_password" name="admin_password" required minlength="8">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="admin_password_confirm" class="form-label">Confirm Password *</label>
                                        <input type="password" class="form-control" id="admin_password_confirm" name="admin_password_confirm" required>
                                    </div>
                                </div>
                                
                                <!-- Already have account -->
                                <div class="text-center mt-4">
                                    <p class="text-muted small">
                                        Already have an account? 
                                        <a href="{% url 'account_login' %}?next={% url 'users:school_onboarding' %}" 
                                           class="text-decoration-none">Sign in here</a>
                                    </p>
                                </div>
                            </div>
                            {% else %}
                            <!-- If already logged in -->
                            <div class="col-lg-6 border-end-lg pe-lg-4 mb-4 mb-lg-0">
                                <h4 class="mb-4"><i class="bi bi-person-check me-2"></i>Your Account</h4>
                                <div class="alert alert-info">
                                    <div class="d-flex">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <div>
                                            <strong>Signed in as {{ request.user.get_full_name|default:request.user.email }}</strong><br>
                                            <small>You'll be the administrator for this school.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Right Column: School Information -->
                            <div class="col-lg-6 ps-lg-4">
                                <h4 class="mb-4"><i class="bi bi-building me-2"></i>School Information</h4>
                                
                                <!-- School Name -->
                                <div class="mb-3">
                                    <label for="school_name" class="form-label">School Name *</label>
                                    <input type="text" class="form-control" id="school_name" name="school_name" required
                                           placeholder="e.g., Bright Future Academy">
                                </div>
                                
                                <!-- School Type -->
                                <div class="mb-3">
                                    <label for="school_type" class="form-label">School Type *</label>
                                    <select class="form-select" id="school_type" name="school_type" required>
                                        <option value="" selected disabled>Select school type</option>
                                        <option value="nursery">Nursery School</option>
                                        <option value="primary">Primary School</option>
                                        <option value="secondary">Secondary School</option>
                                        <option value="combined">Combined School</option>
                                        <option value="full">Full K-12 School</option>
                                        <option value="vocational">Vocational/Training Center</option>
                                        <option value="university">University/College</option>
                                    </select>
                                </div>
                                
                                <!-- Subdomain -->
                                <div class="mb-3">
                                    <label for="subdomain" class="form-label">Custom Subdomain <small class="text-muted">(Optional)</small></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="subdomain" name="subdomain" 
                                               placeholder="yourschool" pattern="[a-zA-Z0-9-]+" minlength="3">
                                        <span class="input-group-text">.edusuite.com</span>
                                    </div>
                                    <div class="form-text">
                                        Leave blank to use path-based URL: edusuite.com/your-school/
                                    </div>
                                    <div id="subdomain-feedback" class="mt-1 small"></div>
                                </div>
                                
                                <!-- Contact Info -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="contact_email" class="form-label">School Email *</label>
                                        <input type="email" class="form-control" id="contact_email" name="contact_email" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone_number" class="form-label">School Phone</label>
                                        <input type="tel" class="form-control" id="phone_number" name="phone_number">
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <div class="mb-4">
                                    <label for="address" class="form-label">School Address</label>
                                    <textarea class="form-control" id="address" name="address" rows="2" 
                                              placeholder="Full street address"></textarea>
                                </div>
                                
                                <!-- Bank Details Section -->
                                <div class="border-top pt-3 mt-3">
                                    <h6 class="text-muted mb-3">Payment Setup <small class="text-muted">(Optional)</small></h6>
                                    <p class="small text-muted mb-3">Add your bank details to receive parent payments directly.</p>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="bank_code" class="form-label">Bank Code</label>
                                                <select class="form-select" id="bank_code" name="bank_code">
                                                    <option value="">Select Bank</option>
                                                    <option value="058">058 - GTBank</option>
                                                    <option value="032">032 - Access Bank</option>
                                                    <option value="033">033 - UBA</option>
                                                    <option value="044">044 - Access Bank (Diamond)</option>
                                                    <option value="050">050 - Ecobank</option>
                                                    <option value="070">070 - Fidelity Bank</option>
                                                    <option value="076">076 - Polaris Bank</option>
                                                    <option value="082">082 - Keystone Bank</option>
                                                    <option value="101">101 - Providus Bank</option>
                                                    <option value="214">214 - First Bank</option>
                                                    <option value="215">215 - Unity Bank</option>
                                                    <option value="221">221 - Stanbic IBTC</option>
                                                    <option value="232">232 - Sterling Bank</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="account_number" class="form-label">Account Number</label>
                                                <input type="text" class="form-control" id="account_number" name="account_number" 
                                                       maxlength="10" pattern="\d{10}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="account_name" class="form-label">Account Name</label>
                                        <input type="text" class="form-control" id="account_name" name="account_name">
                                    </div>
                                    
                                    <div class="alert alert-warning small">
                                        <i class="bi bi-info-circle me-2"></i>
                                        You can skip payment setup and configure it later in the billing settings.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Submit -->
                        <div class="row mt-4 pt-4 border-top">
                            <div class="col-lg-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="agree_terms" name="agree_terms" required>
                                    <label class="form-check-label small" for="agree_terms">
                                        I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> 
                                        and <a href="#" class="text-decoration-none">Privacy Policy</a>. I understand that I get a 30-day free trial with full access.
                                    </label>
                                </div>
                            </div>
                            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                                <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                                    {% if request.user.is_authenticated %}
                                        Create School
                                    {% else %}
                                        Create Account & School
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Benefits Section -->
            <div class="row mt-5">
                <div class="col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3 d-inline-block mb-3">
                        <i class="bi bi-lightning fs-4"></i>
                    </div>
                    <h5>Instant Setup</h5>
                    <p class="text-muted small">Your school is ready in minutes with automated configuration</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3 d-inline-block mb-3">
                        <i class="bi bi-graph-up fs-4"></i>
                    </div>
                    <h5>Complete Features</h5>
                    <p class="text-muted small">Students, parents, attendance, scores, fees, and more</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3 d-inline-block mb-3">
                        <i class="bi bi-shield-check fs-4"></i>
                    </div>
                    <h5>White-label</h5>
                    <p class="text-muted small">Your branding, your colors - parents see only your school</p>
                </div>
            </div>
            
            <!-- Alternative Option -->
            <div class="text-center mt-5">
                <p class="text-muted">
                    Want to join an existing school instead? 
                    <a href="{% url 'school_discovery' %}" class="text-decoration-none">Browse schools</a> or 
                    <a href="{% url 'users:school_list' %}" class="text-decoration-none">view your schools</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('schoolOnboardingForm');
    const subdomainInput = document.getElementById('subdomain');
    const subdomainFeedback = document.getElementById('subdomain-feedback');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const passwordInput = document.getElementById('admin_password');
    const confirmPasswordInput = document.getElementById('admin_password_confirm');

    // Password validation
    if (passwordInput && confirmPasswordInput) {
        function validatePassword() {
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.setCustomValidity("Passwords don't match");
                confirmPasswordInput.classList.add('is-invalid');
            } else {
                confirmPasswordInput.setCustomValidity('');
                confirmPasswordInput.classList.remove('is-invalid');
            }
        }
        
        passwordInput.addEventListener('change', validatePassword);
        confirmPasswordInput.addEventListener('keyup', validatePassword);
    }

    // Subdomain validation
    subdomainInput.addEventListener('input', function() {
        const subdomain = this.value.trim();
        
        // Clear previous feedback
        subdomainFeedback.innerHTML = '';
        this.classList.remove('is-invalid', 'is-valid');
        
        if (subdomain.length === 0) {
            return;
        }

        // Validate format
        const subdomainRegex = /^[a-zA-Z0-9-]+$/;
        if (!subdomainRegex.test(subdomain)) {
            subdomainFeedback.innerHTML = '<span class="text-danger">Only letters, numbers, and hyphens allowed</span>';
            this.classList.add('is-invalid');
            return;
        }

        if (subdomain.length < 3) {
            subdomainFeedback.innerHTML = '<span class="text-warning">Must be at least 3 characters</span>';
            this.classList.add('is-invalid');
            return;
        }

        if (subdomain.length > 30) {
            subdomainFeedback.innerHTML = '<span class="text-warning">Maximum 30 characters</span>';
            this.classList.add('is-invalid');
            return;
        }

        // Check reserved words
        const reserved = ['admin', 'api', 'app', 'dashboard', 'help', 'support', 'www', 'mail', 'ftp'];
        if (reserved.includes(subdomain.toLowerCase())) {
            subdomainFeedback.innerHTML = '<span class="text-danger">This subdomain is reserved</span>';
            this.classList.add('is-invalid');
            return;
        }

        // Show checking message
        subdomainFeedback.innerHTML = '<span class="text-muted">Checking availability...</span>';

        // Simulate API check (you'd implement real API call)
        setTimeout(() => {
            // For demo, assume available if contains 'demo'
            const isAvailable = !subdomain.includes('taken');
            
            if (isAvailable) {
                subdomainFeedback.innerHTML = '<span class="text-success">✓ Subdomain available</span>';
                this.classList.add('is-valid');
            } else {
                subdomainFeedback.innerHTML = '<span class="text-danger">✗ Subdomain not available. Try adding numbers or different words.</span>';
                this.classList.add('is-invalid');
            }
        }, 500);
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        // Validate terms agreement
        const termsCheckbox = document.getElementById('agree_terms');
        if (!termsCheckbox.checked) {
            e.preventDefault();
            alert('Please agree to the Terms of Service and Privacy Policy');
            return false;
        }

        // Validate passwords match
        if (passwordInput && confirmPasswordInput) {
            if (passwordInput.value !== confirmPasswordInput.value) {
                e.preventDefault();
                alert('Passwords do not match');
                return false;
            }
        }

        // Show loading spinner
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
    });

    // Bank account number validation
    const accountNumberInput = document.getElementById('account_number');
    if (accountNumberInput) {
        accountNumberInput.addEventListener('input', function() {
            const value = this.value.replace(/\D/g, '');
            if (value.length > 10) {
                this.value = value.substring(0, 10);
            } else {
                this.value = value;
            }
        });
    }
});
</script>
{% endblock %}