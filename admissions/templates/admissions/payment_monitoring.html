{% extends "base.html" %}

{% block title %}Payment Monitoring - {{ school.name }}{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
    background: white;
}

.stat-number {
    font-size: 1.75rem;
    font-weight: bold;
    color: var(--school-primary);
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.payment-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">Payment Monitoring</h1>
            <p class="text-muted mb-0">Track and manage application fee payments</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary" hx-get="{% url 'admissions:payment_stats' %}" 
                    hx-target="#paymentStats" hx-trigger="load, every 30s">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <a href="{% url 'admissions:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Payment Statistics -->
    <div id="paymentStats" class="mb-4">
        <!-- HTMX will load stats here -->
    </div>
    
    <!-- Pending Payments -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-clock-history text-warning me-2"></i>
                Pending Payments
                <span class="badge bg-warning ms-2">{{ pending_applications|length }}</span>
            </h5>
            <small class="text-muted">Applications awaiting payment completion</small>
        </div>
        <div class="card-body p-0">
            {% if pending_applications %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Application #</th>
                            <th>Student</th>
                            <th>Parent</th>
                            <th>Amount</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in pending_applications %}
                        <tr>
                            <td>
                                <strong>{{ app.application_number }}</strong><br>
                                <small class="text-muted">{{ app.form.name }}</small>
                            </td>
                            <td>{{ app.student_full_name }}</td>
                            <td>
                                {{ app.parent.full_name }}<br>
                                <small class="text-muted">{{ app.parent.email }}</small>
                            </td>
                            <td>
                                {% if app.application_fee_invoice %}
                                <strong>₦{{ app.application_fee_invoice.total_amount|floatformat:2 }}</strong>
                                {% else %}
                                <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ app.submitted_at|date:"M j, Y" }}<br>
                                <small class="text-muted">{{ app.submitted_at|timesince }} ago</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'admissions:retry_payment' app.id %}" 
                                       class="btn btn-outline-primary" title="Retry Payment">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </a>
                                    <button class="btn btn-outline-success" 
                                            hx-post="{% url 'admissions:waive_fee' app.id %}"
                                            hx-confirm="Waive application fee for {{ app.application_number }}?"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            title="Waive Fee">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <a href="{% url 'admissions:application_detail' app.id %}" 
                                       class="btn btn-outline-info" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle display-1 text-success mb-3"></i>
                <h4>No Pending Payments</h4>
                <p class="text-muted">All application fees have been processed.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Failed Payments -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-x-circle text-danger me-2"></i>
                Failed Payments
                <span class="badge bg-danger ms-2">{{ failed_invoices|length }}</span>
            </h5>
            <small class="text-muted">Payments that failed or were declined</small>
        </div>
        <div class="card-body p-0">
            {% if failed_invoices %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Student</th>
                            <th>Amount</th>
                            <th>Failed On</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in failed_invoices %}
                        <tr>
                            <td>
                                <strong>{{ invoice.invoice_number }}</strong><br>
                                <small class="text-muted">{{ invoice.parent.email }}</small>
                            </td>
                            <td>
                                {% if invoice.student %}
                                {{ invoice.student.full_name }}
                                {% else %}
                                <span class="text-muted">No student linked</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>₦{{ invoice.total_amount|floatformat:2 }}</strong><br>
                                <small class="text-muted">{{ invoice.invoice_type|title }} Fee</small>
                            </td>
                            <td>
                                {{ invoice.created_at|date:"M j, Y" }}<br>
                                <small class="text-muted">{{ invoice.created_at|timesince }} ago</small>
                            </td>
                            <td>
                                <span class="badge bg-danger payment-status-badge">
                                    Payment Failed
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="#" class="btn btn-outline-primary" 
                                       hx-get="#"
                                       hx-target="#invoiceModal"
                                       hx-trigger="click"
                                       data-bs-toggle="modal"
                                       data-bs-target="#invoiceModal"
                                       title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="mailto:{{ invoice.parent.email }}?subject=Payment Failed - {{ invoice.invoice_number }}"
                                       class="btn btn-outline-warning" title="Contact Parent">
                                        <i class="bi bi-envelope"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-emoji-smile display-1 text-success mb-3"></i>
                <h4>No Failed Payments</h4>
                <p class="text-muted">Great! All payments are processing successfully.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Invoice Details Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody">
                <!-- HTMX will load content here -->
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh stats every 30 seconds
setInterval(() => {
    htmx.trigger('#paymentStats', 'refresh');
}, 30000);
</script>
{% endblock %}