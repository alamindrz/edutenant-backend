<!-- Desktop Sidebar as Offcanvas - UPDATED -->
<div class="offcanvas offcanvas-start d-none d-lg-block" tabindex="-1" id="sidebarOffcanvas" style="width: 280px;">
    <div class="offcanvas-header border-bottom">
        <div class="d-flex align-items-center w-100">
            <div class="flex-shrink-0">
                <i class="bi bi-house-door-fill text-primary fs-4"></i>
            </div>
            <div class="flex-grow-1 ms-2">
                <h6 class="mb-0 fw-bold">School System</h6>
                {% if request.school %}
                <small class="text-muted">{{ request.school.name }}</small>
                {% endif %}
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <!-- User Info -->
        <div class="px-3 py-3 border-bottom bg-light">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-person-circle fs-2 text-muted"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="mb-0">{{ request.user.get_full_name|default:request.user.username }}</h6>
                    <small class="text-muted">
                        {% if request.school %}
                            {{ request.school.name }}
                        {% else %}
                            {% if user_profile.role %}{{ user_profile.role.name }}{% else %}User{% endif %}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        {% if request.school %}
        <div class="p-3 bg-light border-bottom">
            <div class="row g-2 text-center">
                <div class="col-4">
                    <div class="p-2 bg-white rounded">
                        <div class="h6 mb-0 text-primary">
                            {{ request.school.student_set.count|default:0 }}
                        </div>
                        <small class="text-muted">Students</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-white rounded">
                        <div class="h6 mb-0 text-success">
                            {{ request.school.staff_set.count|default:0 }}
                        </div>
                        <small class="text-muted">Staff</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-white rounded">
                        <div class="h6 mb-0 text-info">
                            {{ request.school.classgroup_set.count|default:0 }}
                        </div>
                        <small class="text-muted">Classes</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Navigation Menu -->
        <nav class="nav flex-column py-2">
            <!-- Quick Access -->
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Quick Access</div>
            <a href="{% url 'users:dashboard' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'dashboard' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-3 text-primary"></i>
                <span>Dashboard</span>
            </a>
            
            <a href="{% url 'school_discovery' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'discover' %}active{% endif %}">
                <i class="bi bi-search me-3 text-success"></i>
                <span>Discover Schools</span>
            </a>
            
            <!-- My Applications - FOR TEACHERS/APPLICANTS ONLY -->
            {% if not user_can_manage_admissions %}
            <a href="{% url 'users:my_applications' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'applications' %}active{% endif %}">
                <i class="bi bi-file-earmark-person me-3 text-primary"></i>
                <span>My Applications</span>
                {% if my_pending_applications and my_pending_applications > 0 %}
                <span class="badge bg-warning ms-auto">{{ my_pending_applications }}</span>
                {% endif %}
            </a>
            {% endif %}

            <!-- Admissions Management - FOR PRINCIPALS/ADMINS ONLY -->
            {% if user_can_manage_admissions %}
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Admissions</div>
            <a href="{% url 'admissions:dashboard' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'admissions' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-3 text-primary"></i>
                <span>Admissions Dashboard</span>
                {% if admission_pending_count and admission_pending_count > 0 %}
                <span class="badge bg-warning ms-auto">{{ admission_pending_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'admissions:application_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'student_applications' %}active{% endif %}">
                <i class="bi bi-pencil-square me-3 text-info"></i>
                <span>Student Applications</span>
                {% if admission_pending_count and admission_pending_count > 0 %}
                <span class="badge bg-danger ms-auto">{{ admission_pending_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'admissions:admission_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'admission_offers' %}active{% endif %}">
                <i class="bi bi-person-check me-3 text-success"></i>
                <span>Admission Offers</span>
            </a>
            <a href="{% url 'admissions:manage_application_forms' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'application_forms' %}active{% endif %}">
                <i class="bi bi-file-earmark-text me-3 text-warning"></i>
                <span>Application Forms</span>
            </a>
            {% endif %}

            <!-- Staff Management - FOR PRINCIPALS/ADMINS ONLY -->
            {% if user_can_manage_staff %}
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Staff Management</div>
            <a href="{% url 'users:staff_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'staff' %}active{% endif %}">
                <i class="bi bi-person-badge me-3 text-primary"></i>
                <span>Staff Directory</span>
            </a>
            <a href="{% url 'users:school_applications' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'teacher_applications' %}active{% endif %}">
                <i class="bi bi-person-check me-3 text-info"></i>
                <span>Teacher Applications</span>
                {% if pending_applications_count and pending_applications_count > 0 %}
                <span class="badge bg-danger ms-auto">{{ pending_applications_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'users:staff_create' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'staff_create' %}active{% endif %}">
                <i class="bi bi-person-plus me-3 text-success"></i>
                <span>Add Staff</span>
            </a>
            <a href="{% url 'users:role_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'roles' %}active{% endif %}">
                <i class="bi bi-shield-check me-3 text-warning"></i>
                <span>Role Management</span>
            </a>
            <a href="{% url 'users:manage_open_positions' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'positions' %}active{% endif %}">
                <i class="bi bi-briefcase me-3 text-secondary"></i>
                <span>Open Positions</span>
            </a>
            {% endif %}

            <!-- Student Management - FOR TEACHERS & ADMINS -->
            {% if user_can_view_students %}
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Students</div>
            <a href="{% url 'students:student_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'students' %}active{% endif %}">
                <i class="bi bi-people me-3 text-primary"></i>
                <span>All Students</span>
            </a>
            <a href="{% url 'students:parent_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'parents' %}active{% endif %}">
                <i class="bi bi-people-fill me-3 text-info"></i>
                <span>Parents</span>
            </a>
            {% if user_profile.role.system_role_type == 'parent' %}
            <a href="{% url 'students:parent_dashboard' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'parent_portal' %}active{% endif %}">
                <i class="bi bi-person-badge me-3 text-success"></i>
                <span>Parent Portal</span>
            </a>
            {% endif %}
            {% endif %}

            <!-- Academic Management - FOR TEACHERS & ADMINS -->
            {% if user_can_manage_academics %}
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Academic</div>
            <a href="{% url 'core:class_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'classes' %}active{% endif %}">
                <i class="bi bi-journal me-3 text-primary"></i>
                <span>Classes</span>
            </a>
            <a href="{% url 'core:subject_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'subjects' %}active{% endif %}">
                <i class="bi bi-book me-3 text-success"></i>
                <span>Subjects</span>
            </a>
            {% endif %}

            <!-- Attendance - FOR TEACHERS & ADMINS -->
            {% if user_can_manage_attendance %}
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">Attendance</div>
            <a href="{% url 'attendance:dashboard' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'attendance' %}active{% endif %}">
                <i class="bi bi-check-circle me-3 text-success"></i>
                <span>Attendance</span>
            </a>
            {% endif %}

            <!-- System -->
            <div class="px-3 pt-3 small fw-bold text-uppercase text-muted">System</div>
            <a href="{% url 'users:school_list' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'schools' %}active{% endif %}">
                <i class="bi bi-building me-3 text-secondary"></i>
                <span>My Schools</span>
            </a>
            <a href="{% url 'users:profile' %}" class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center {% if current_section == 'profile' %}active{% endif %}">
                <i class="bi bi-gear me-3 text-secondary"></i>
                <span>Settings</span>
            </a>
            <button class="nav-link sidebar-nav-item px-3 py-2 d-flex align-items-center border-0 bg-transparent" onclick="toggleDarkMode()">
                <i class="bi bi-moon me-3 text-secondary"></i>
                <span id="theme-toggle-text">Dark Mode</span>
            </button>
        </nav>
    </div>
    
    <!-- Sidebar Footer -->
    <div class="offcanvas-footer border-top p-3 bg-light">
        <div class="d-grid gap-2">
            <a href="{% url 'users:profile' %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-person me-2"></i>My Profile
            </a>
            <a href="{% url 'account_logout' %}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a>
        </div>
    </div>
</div>

<!-- Sidebar Styles -->
<style>
.sidebar-nav-item {
    border-radius: 0.5rem;
    margin: 0.125rem 0.5rem;
    transition: all 0.2s ease;
    border: none;
    color: var(--bs-secondary);
}

.sidebar-nav-item:hover {
    background-color: var(--bs-primary);
    color: white !important;
    transform: translateX(4px);
}

.sidebar-nav-item:hover i {
    color: white !important;
}

.sidebar-nav-item.active {
    background-color: var(--bs-primary);
    color: white !important;
}

.sidebar-nav-item.active i {
    color: white !important;
}

[data-bs-theme="dark"] .sidebar-nav-item {
    color: var(--bs-light);
}

[data-bs-theme="dark"] .sidebar-nav-item:hover {
    background-color: var(--bs-primary);
}

/* Main content adjustment */
.main-content {
    margin-left: 280px;
    transition: margin-left 0.3s ease;
}

@media (max-width: 991.98px) {
    .main-content {
        margin-left: 0;
    }
}

/* Smooth sidebar transitions */
.offcanvas-start {
    transition: transform 0.3s ease-in-out;
}

/* Badge styles */
.sidebar-nav-item .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

/* Section headers */
.small.text-uppercase {
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

/* Quick stats cards */
.bg-white {
    background: white !important;
}

[data-bs-theme="dark"] .bg-white {
    background: var(--bs-dark) !important;
}

/* Loading animation for badges */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.sidebar-nav-item .badge {
    animation: pulse 2s infinite;
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .sidebar-nav-item,
    .sidebar-nav-item .badge {
        transition: none;
        animation: none;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update theme toggle text based on current theme
    function updateThemeToggleText() {
        const themeToggleText = document.getElementById('theme-toggle-text');
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        if (themeToggleText) {
            themeToggleText.textContent = currentTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }
    }
    
    // Initialize theme text
    updateThemeToggleText();
    
    // Enhanced dark mode toggle
    window.toggleDarkMode = function() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        // Apply theme
        html.setAttribute('data-bs-theme', newTheme);
        updateThemeToggleText();
        
        // Save to localStorage
        localStorage.setItem('theme', newTheme);
        
        // Update navbar background
        updateNavbarTheme(newTheme);
    }
    
    function updateNavbarTheme(theme) {
        const navbar = document.getElementById('main-header');
        const mobileNav = document.getElementById('mobile-bottom-nav');
        
        if (navbar) {
            if (theme === 'dark') {
                navbar.classList.remove('navbar-light', 'bg-white');
                navbar.classList.add('navbar-dark', 'bg-dark');
            } else {
                navbar.classList.remove('navbar-dark', 'bg-dark');
                navbar.classList.add('navbar-light', 'bg-white');
            }
        }
        
        if (mobileNav) {
            if (theme === 'dark') {
                mobileNav.classList.remove('navbar-light', 'bg-white');
                mobileNav.classList.add('navbar-dark', 'bg-dark');
            } else {
                mobileNav.classList.remove('navbar-dark', 'bg-dark');
                mobileNav.classList.add('navbar-light', 'bg-white');
            }
        }
    }

    // Auto-collapse sidebar on mobile
    if (window.innerWidth < 992) {
        const sidebar = document.getElementById('sidebarOffcanvas');
        if (sidebar) {
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar);
            if (bsOffcanvas) {
                bsOffcanvas.hide();
            }
        }
    }
    
    // Add active state based on current URL
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll('.sidebar-nav-item');
    
    navItems.forEach(item => {
        if (item.href && currentPath.startsWith(new URL(item.href).pathname)) {
            item.classList.add('active');
        }
    });
});
</script>